import requests
from telethon import TelegramClient, events
from telethon.errors import FloodWait
import time

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API
API_ID = "27162215"  # API ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
API_HASH = "ccad75107a0bd1ed8626180aaa5a596e"  # API Hash Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
BOT_TOKEN = "Ø¶Ø¹_Ø±Ù…Ø²_Ø§Ù„Ø±ÙˆØ¨ÙˆØª_Ù‡Ù†Ø§"  # Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ù…Ø² Ø§Ù„Ø±ÙˆØ¨ÙˆØª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
TOMARKET_API_URL = "https://example.com/api"  # Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ø±Ø§Ø¨Ø· API Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Tomarket

client = TelegramClient('bot', API_ID, API_HASH).start(bot_token=BOT_TOKEN)

# ÙˆØ¸ÙŠÙØ© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
def check_username(username):
    return "ğŸ…" in username

# ÙˆØ¸ÙŠÙØ© Ù„Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·
async def collect_points(username, quantity):
    response = requests.post(f"{TOMARKET_API_URL}/collect", data={"username": username, "quantity": quantity})
    return response

@client.on(events.NewMessage(pattern='/start'))
async def start(event):
    await event.respond("Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ù…Ø± /collect Ù„Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·.")

@client.on(events.NewMessage(pattern='/collect'))
async def collect(event):
    username = event.sender.username

    # ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if not check_username(username):
        await event.respond("ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ¶Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ğŸ… Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±ÙˆØ¨ÙˆØª.")
        return

    await event.respond("Ù…Ù† ÙØ¶Ù„ÙƒØŒ Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ØªÙŠ ØªØ±ØºØ¨ ÙÙŠ Ø¬Ù…Ø¹Ù‡Ø§:")
    
    @client.on(events.NewMessage(from_users=event.sender.id))
    async def get_quantity(quantity_event):
        try:
            quantity = int(quantity_event.message.text)
            if quantity > 0:
                response = await collect_points(username, quantity)
                
                if response.status_code == 200:
                    await event.respond(f"ØªÙ… Ø¬Ù…Ø¹ {quantity} Ø·Ù…Ø§Ø·Ù… Ø¨Ù†Ø¬Ø§Ø­!")
                else:
                    await event.respond("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
            else:
                await event.respond("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø© Ø£ÙƒØ¨Ø± Ù…Ù† 0.")
        except ValueError:
            await event.respond("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ ÙÙ‚Ø·.")
        except FloodWait as e:
            await event.respond(f"ØªÙˆÙ‚Ù Ù…Ø¤Ù‚Øª Ù„Ù…Ø¯Ø© {e.seconds} Ø«Ø§Ù†ÙŠØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.")
            time.sleep(e.seconds)
            await collect(event)

@client.on(events.NewMessage(pattern='/balance'))
async def balance(event):
    username = event.sender.username
    response = requests.get(f"{TOMARKET_API_URL}/balance", params={"username": username})

    if response.status_code == 200:
        balance_data = response.json()
        await event.respond(f"Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: {balance_data['balance']} Ø·Ù…Ø§Ø·Ù….")
    else:
        await event.respond("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø±ØµÙŠØ¯.")

@client.on(events.NewMessage(pattern='/help'))
async def help(event):
    help_text = (
        "Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:\n"
        "/collect - Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·.\n"
        "/balance - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ.\n"
        "/help - Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©."
    )
    await event.respond(help_text)

# Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±ÙˆØ¨ÙˆØª
client.start()
client.run_until_disconnected()
